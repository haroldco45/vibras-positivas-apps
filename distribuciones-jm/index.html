<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distribuciones JM - Toma de Pedidos</title>
    <style>
        :root { --azul: #0d47a1; --dorado: #ffc107; --gris: #f4f4f4; }
        body { font-family: sans-serif; background: var(--gris); margin: 0; padding: 10px; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 15px; }
        h3 { color: var(--azul); margin-top: 0; border-bottom: 2px solid var(--dorado); padding-bottom: 5px; }
        input, select, datalist { width: 100%; padding: 10px; margin: 5px 0 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .btn { background: var(--azul); color: white; border: none; padding: 12px; width: 100%; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .btn-add { background: #2e7d32; margin-top: 10px; }
        .item-pedido { display: flex; justify-content: space-between; background: #eee; padding: 8px; margin-bottom: 5px; border-radius: 5px; font-size: 14px; }
    </style>
</head>
<body>

<div class="card">
    <h3>ðŸ‘¤ Datos del Cliente</h3>
    <input type="text" id="busquedaCliente" list="listaClientes" placeholder="Escriba nombre o celular..." oninput="seleccionarCliente(this.value)">
    <datalist id="listaClientes"></datalist>
    
    <input type="text" id="nomCliente" placeholder="Nombre completo">
    <input type="tel" id="telCliente" placeholder="Celular">
    <input type="text" id="dirCliente" placeholder="DirecciÃ³n y Barrio">
</div>

<div class="card">
    <h3>ðŸ“¦ Agregar Productos</h3>
    <input type="text" id="busquedaProd" list="listaProds" placeholder="Buscar o escribir producto nuevo..." oninput="cargarPrecioSugerido(this.value)">
    <datalist id="listaProds"></datalist>
    
    <div style="display: flex; gap: 10px;">
        <input type="number" id="precioProd" placeholder="Precio $">
        <input type="number" id="cantProd" placeholder="Cant">
    </div>
    <button class="btn btn-add" onclick="agregarAlCarrito()">+ Agregar al Pedido</button>
</div>

<div class="card">
    <h3>ðŸ›’ Detalle del Pedido</h3>
    <div id="carrito"></div>
    <hr>
    <div style="text-align: right; font-weight: bold; font-size: 18px;">
        TOTAL: $<span id="totalPedido">0</span>
    </div>
    <button class="btn" style="margin-top: 15px; background: #25d366;" onclick="enviarPedido()">ðŸš€ ENVIAR POR WHATSAPP</button>
</div>

<script>
    let dbClientes = JSON.parse(localStorage.getItem('jm_clientes')) || [];
    let dbProductos = JSON.parse(localStorage.getItem('jm_productos')) || [];
    let carrito = [];

    // Cargar listas al iniciar
    function actualizarDatalists() {
        const dlClientes = document.getElementById('listaClientes');
        dlClientes.innerHTML = dbClientes.map(c => `<option value="${c.n} | ${c.t}">`).join('');

        const dlProds = document.getElementById('listaProds');
        dlProds.innerHTML = dbProductos.map(p => `<option value="${p.n}">`).join('');
    }

    function seleccionarCliente(val) {
        const cliente = dbClientes.find(c => `${c.n} | ${c.t}` === val);
        if(cliente) {
            document.getElementById('nomCliente').value = cliente.n;
            document.getElementById('telCliente').value = cliente.t;
            document.getElementById('dirCliente').value = cliente.d;
        }
    }

    function cargarPrecioSugerido(val) {
        const prod = dbProductos.find(p => p.n === val);
        if(prod) document.getElementById('precioProd').value = prod.p;
    }

    function agregarAlCarrito() {
        const nombre = document.getElementById('busquedaProd').value;
        const precio = parseFloat(document.getElementById('precioProd').value);
        const cant = parseInt(document.getElementById('cantProd').value);

        if(!nombre || !precio || !cant) return alert("Complete los datos del producto");

        carrito.push({ n: nombre, p: precio, c: cant });
        
        // Guardar producto en la "memoria" si es nuevo o actualizÃ³ precio
        const index = dbProductos.findIndex(p => p.n === nombre);
        if(index === -1) dbProductos.push({ n: nombre, p: precio });
        else dbProductos[index].p = precio;
        
        localStorage.setItem('jm_productos', JSON.stringify(dbProductos));
        renderCarrito();
        actualizarDatalists();
        
        // Limpiar campos de producto
        document.getElementById('busquedaProd').value = '';
        document.getElementById('precioProd').value = '';
        document.getElementById('cantProd').value = '';
    }

    function renderCarrito() {
        const cont = document.getElementById('carrito');
        let total = 0;
        cont.innerHTML = carrito.map((item, i) => {
            total += (item.p * item.c);
            return `<div class="item-pedido">
                        <span>${item.n} (x${item.c})</span>
                        <span>$${(item.p * item.c).toLocaleString()}</span>
                    </div>`;
        }).join('');
        document.getElementById('totalPedido').innerText = total.toLocaleString();
    }

    function enviarPedido() {
        const n = document.getElementById('nomCliente').value;
        const t = document.getElementById('telCliente').value;
        const d = document.getElementById('dirCliente').value;

        if(!n || carrito.length === 0) return alert("Faltan datos del cliente o productos");

        // Guardar/Actualizar Cliente en memoria
        const idxC = dbClientes.findIndex(c => c.t === t);
        if(idxC === -1) dbClientes.push({ n: n, t: t, d: d });
        else dbClientes[idxC] = { n: n, t: t, d: d };
        localStorage.setItem('jm_clientes', JSON.stringify(dbClientes));

        // Formar mensaje de WhatsApp
        let msg = `*ðŸ“¦ DISTRIBUCIONES JM - PEDIDO*\n`;
        msg += `ðŸ‘¤ CLIENTE: ${n}\nðŸ“ž TEL: ${t}\nðŸ“ DIR: ${d}\n`;
        msg += `--------------------------\n`;
        carrito.forEach(i => {
            msg += `ðŸ”¹ ${i.n} (x${i.c}) = $${(i.p * i.c).toLocaleString()}\n`;
        });
        msg += `--------------------------\n`;
        msg += `ðŸ’° *TOTAL: $${document.getElementById('totalPedido').innerText}*`;

        window.location.href = `https://wa.me/573014024397?text=${encodeURIComponent(msg)}`;
    }

    window.onload = actualizarDatalists;
</script>
</body>
</html>
